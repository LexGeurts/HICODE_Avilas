import requests
import random
import re # Import regex for cleaning instructions

def find_recipe(api_key, ingredients, query_wish):
    """
    Fetches a recipe from the Spoonacular API based on a list of ingredients
    and an optional query wish (e.g., "healthy").
    """
    
    # --- Step 1: Find recipes by ingredients ---
    
    search_url = 'https://api.spoonacular.com/recipes/findByIngredients'
    
    # Format ingredients for the API: "chicken,+broccoli,+garlic"
    ingredients_str = ',+'.join(ingredients)
    
    search_params = {
        'apiKey': api_key,
        'ingredients': ingredients_str,
        'query': query_wish,          # Pass the "wish" as a general query
        'number': 10,                 # Get 10 recipes to randomize from
        'ranking': 1,                 # Maximize used ingredients
        'ignorePantry': True,         # Ignore common pantry items
        'instructionsRequired': True  # Only get recipes that have instructions
    }
    
    print(f"Searching for '{query_wish}' recipes with: {', '.join(ingredients)}...")
    
    try:
        # --- First API Call ---
        response = requests.get(search_url, params=search_params, timeout=10)
        response.raise_for_status() # Check for HTTP errors
        
        recipes = response.json()
        
        if not recipes:
            print(f"Sorry, no recipes found matching your criteria.")
            return

        print(f"\nFound {len(recipes)} matching recipe(s). Picking one at random...")

        # Pick a random recipe from the list
        chosen_recipe_summary = random.choice(recipes)
        recipe_id = chosen_recipe_summary.get('id')

        # --- Step 2: Get the full details for the chosen recipe ---
        
        if not recipe_id:
            print("Error: Found a recipe but it has no ID. Cannot get details.")
            return

        info_url = f'https://api.spoonacular.com/recipes/{recipe_id}/information'
        info_params = {
            'apiKey': '5f491dd56fb148d7b417dc3d1a4c4830',
            'includeNutrition': False # Save API quota points
        }

        # --- Second API Call ---
        info_response = requests.get(info_url, params=info_params, timeout=10)
        info_response.raise_for_status()
        
        recipe_details = info_response.json()

        # --- 3. Print the Full Recipe ---
        print("\n--- Found a Recipe! ---")
        print(f"Title: {recipe_details.get('title')}")
        print(f"Servings: {recipe_details.get('servings')}")
        print(f"Ready in: {recipe_details.get('readyInMinutes')} minutes")
        print(f"Source: {recipe_details.get('sourceUrl')}")

        # Print a clean list of *all* ingredients for the recipe
        print("\nIngredients:")
        if recipe_details.get('extendedIngredients'):
            for ingredient in recipe_details['extendedIngredients']:
                print(f"- {ingredient.get('original')}")
        
        # Clean up and print instructions (they sometimes contain HTML)
        print("\nInstructions:")
        instructions = recipe_details.get('instructions')
        if instructions:
            # Remove HTML tags (like <li>, <ol>, <b>)
            clean_instructions = re.sub(r'<[^>]+>', '', instructions)
            print(clean_instructions)
        else:
            print("No instructions provided. Check the source URL for details.")

            
    except requests.exceptions.HTTPError as http_err:
        # Handle specific HTTP errors
        if http_err.response.status_code == 401:
            print("\nError: Authentication failed. Please check your Spoonacular API_KEY.")
            print("You can get a free key from https://spoonacular.com/food-api")
        elif http_err.response.status_code == 402:
            print("\nError: API quota exceeded. The Spoonacular free plan is limited.")
            print(f"Details: {http_err.response.json().get('message')}")
        else:
            print(f"\nHTTP error occurred: {http_err} - {http_err.response.text}")
    except requests.exceptions.RequestException as e:
        # Handle other errors like network issues, timeouts, etc.
        print(f"\nAn error occurred during the API request: {e}")
    except Exception as e:
        print(f"\nAn unexpected error occurred: {e}")

# --- --- --- --- --- --- --- --- --- ---
# --- HOW TO USE THIS SCRIPT ---
# --- --- --- --- --- --- --- --- --- ---
if __name__ == "__main__":
    
    # 1. Get your free API key from https://spoonacular.com/food-api
    # 2. Paste your API key here:
    API_KEY = '5f491dd56fb148d7b417dc3d1a4c4830'
    
    # 3. Add any specific wish for the recipe (e.g., "healthy", "quick", "vegan", "dessert")
    user_wish = 'healthy'
    
    # 4. Change this list to the ingredients you have
    ingredients_to_find = ['chicken', 'broccoli', 'garlic', 'olive oil']
    
    # Check if the user has updated the API key
    if API_KEY == 'YOUR_API_KEY_HERE':
        print("="*50)
        print("ERROR: Please update the 'API_KEY' variable in this script.")
        print("You must get a new key from https://spoonacular.com/food-api")
        print("="*50)
    else:
        # Run the function to find the recipe
        find_recipe(API_KEY, ingredients_to_find, user_wish)

